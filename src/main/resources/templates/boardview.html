<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ê²Œì‹œê¸€ ìƒì„¸ í˜ì´ì§€</title>
    <script src="https://code.jquery.com/jquery-3.6.3.min.js" integrity="sha256-pvPw+upLPUjgMXY0G+8O0xUf+/Im1MZjXxxgOcBQBXU=" crossorigin="anonymous"></script>
</head>
<body>
<h1 th:text="${board.title}">ì œëª©ì…ë‹ˆë‹¤</h1>
<p>
    <span id="heart-button">ğŸ¤</span>
    <span id="heart-count" th:text="${board.heartCount}">0</span>
</p>

<p th:text="|ì¡°íšŒìˆ˜ : ${board.viewCount}|">ì¡°íšŒìˆ˜</p>
<p th:text="|ì‘ì„±ì: ${board.memberId}|">ì‘ì„±ì</p>
<p th:text="|ì‘ì„± ë‚ ì§œ: ${#dates.format(board.boardCreatedTime, 'yyyy-MM-dd')}|"></p>
<p th:text="${board.content}">ë‚´ìš©ì´ ë“¤ì–´ê°ˆ ë¶€ë¶„ì…ë‹ˆë‹¤</p>

<!-- ì´ë¯¸ì§€ íŒŒì¼ì´ë©´ í™”ë©´ì— í‘œì‹œ -->
<div th:if="${board.filename}">
    <img th:src="${board.filepath}" alt="ê²Œì‹œê¸€ ì´ë¯¸ì§€" style="max-width: 100%; height: auto;">
</div>

<th:block th:if="${board.memberId == 'testUser'}">
    <a th:href="@{/free-board/delete/{boardId}/{memberId}(boardId=${board.id}, memberId=${board.memberId})}">ì‚­ì œ</a>
    <a th:href="@{/free-board/modify/{boardId}/{memberId}(boardId=${board.id}, memberId=${board.memberId})}">ìˆ˜ì •</a>
</th:block>


<p></p>
<div>
    <input type="text" id="commentContents" placeholder="ë‚´ìš©">
    <button id="comment-write-btn" onclick="commentWrite()">ëŒ“ê¸€ì‘ì„±</button>
</div>
<p></p>
<div id="comment-list">
    <table>
        <thead>
        <tr>
            <th>ëŒ“ê¸€ë²ˆí˜¸</th>
            <th>ì‘ì„±ì</th>
            <th>ë‚´ìš©</th>
            <th>ì‘ì„±ì‹œê°„</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="comment : ${commentList}">
            <td th:text="${comment.id}"></td>
            <td th:text="${comment.memberId}"></td>
            <td th:text="${comment.commentContents}"></td>
            <td th:text="${#dates.format(comment.commentCreatedTime, 'yyyy-MM-dd HH:mm')}"></td>
            <td>
                <button th:attr="onclick='deleteComment(' + ${comment.id} + ',\'' + ${comment.memberId} + '\')'">ì‚­ì œ</button>
            </td>
        </tr>
        </tbody>
    </table>
</div>
</body>
<script th:inline="javascript">
    const commentWrite = () => {
        const memberId = 1;  // ì„ì‹œ íšŒì› ID (ë¡œê·¸ì¸ ì‹œìŠ¤í…œ êµ¬í˜„ ì „ê¹Œì§€ ì‚¬ìš©)
        const contents = document.getElementById('commentContents').value;
        const boardId = '[[${board.id}]]';

        $.ajax({
            type: "POST",
            url: "/free-comment/save",
            contentType: "application/json",
            data: JSON.stringify({
                memberId: memberId, // ì‘ì„±ìë¥¼ ì„ì˜ì˜ íšŒì›ë²ˆí˜¸ë¡œ ì„¤ì •
                commentContents: contents,
                boardId: boardId
            }),
            dataType: "json",
            success: function (commentList) {
                console.log("ì‘ì„± ì„±ê³µ");
                console.log(commentList);
                let output = "<table>";
                output += "<tr><th>ëŒ“ê¸€ë²ˆí˜¸</th>";
                output += "<th>ì‘ì„±ì</th>";
                output += "<th>ë‚´ìš©</th>";
                output += "<th>ì‘ì„±ì‹œê°„</th></tr>";
                for(let i in commentList){
                    output += "<tr>";
                    output += "<td>"+commentList[i].id+"</td>";
                    output += "<td>"+commentList[i].memberId+"</td>";
                    output += "<td>"+commentList[i].commentContents+"</td>";
                    output += "<td>"+commentList[i].commentCreatedTime+"</td>";
                    output += "</tr>";
                }
                output += "</table>";
                document.getElementById('comment-list').innerHTML = output;
                document.getElementById('commentContents').value='';
            },
            error: function () {
                console.log("ì‘ì„± ì‹¤íŒ¨");
            }
        });
    };
</script>

<script th:inline="javascript">
    function deleteComment(commentId, memberId) {
        const currentUser = "1"; // ì„ì‹œ ì‚¬ìš©ì ID
        if (memberId !== currentUser) {
            alert("ë³¸ì¸ì´ ì‘ì„±í•œ ëŒ“ê¸€ë§Œ ì‚­ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
            return;
        }

        $.ajax({
            type: "DELETE",
            url: `/free-comment/delete/${commentId}/${memberId}`,
            success: function () {
                alert("ëŒ“ê¸€ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                location.reload();
            },
            error: function (xhr) {
                alert(xhr.responseText || "ì‚­ì œ ì‹¤íŒ¨");
            }
        });
    }
</script>

<script th:inline="javascript">
    $(document).ready(function () {
        const memberId = 1;  // ì„ì‹œ íšŒì› ID (ì‹¤ì œ ë¡œê·¸ì¸ ì •ë³´ ì—°ë™ í•„ìš”)
        const boardId = '[[${board.id}]]';

        // ì¢‹ì•„ìš” ì—¬ë¶€ í™•ì¸ í›„ í•˜íŠ¸ ìƒ‰ ë³€ê²½
        $.get(`/free-board/like/${memberId}/${boardId}`, function (isLiked) {
            if (isLiked) {
                $("#heart-button").text("â¤ï¸");
            }
        });

        // í•˜íŠ¸ í´ë¦­ ì´ë²¤íŠ¸
        $("#heart-button").click(function () {
            let heartCount = parseInt($("#heart-count").text()) || 0; // ìˆ«ìë¡œ ë³€í™˜, NaN ë°©ì§€

            if ($("#heart-button").text() === "ğŸ¤") {
                $.ajax({
                    type: "POST",
                    url: `/free-board/like/${memberId}/${boardId}`,
                    success: function () {
                        $("#heart-button").text("â¤ï¸");
                        $("#heart-count").text(heartCount + 1); // ìˆ«ì ì¦ê°€
                    },
                    error: function () {
                        console.log("ì¢‹ì•„ìš” ì¶”ê°€ ì‹¤íŒ¨");
                    }
                });
            } else {
                $.ajax({
                    type: "DELETE",
                    url: `/free-board/like/${memberId}/${boardId}`,
                    success: function () {
                        $("#heart-button").text("ğŸ¤");
                        $("#heart-count").text(Math.max(0, heartCount - 1)); // ìˆ«ì ê°ì†Œ, ìµœì†Œ 0
                    },
                    error: function () {
                        console.log("ì¢‹ì•„ìš” ì‚­ì œ ì‹¤íŒ¨");
                    }
                });
            }
        });
    });
</script>


</html>
