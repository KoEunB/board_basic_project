<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>게시글 상세 페이지</title>
    <script src="https://code.jquery.com/jquery-3.6.3.min.js" integrity="sha256-pvPw+upLPUjgMXY0G+8O0xUf+/Im1MZjXxxgOcBQBXU=" crossorigin="anonymous"></script>
</head>
<body>
<h1 th:text="${board.title}">제목입니다</h1>
<p>
    <span id="heart-button" style="cursor: pointer; font-size: 20px;">🤍</span>
    <span id="heart-count" th:text="${board.heartCount}">0</span>
</p>

<p th:text="|조회수 : ${board.viewCount}|">조회수</p>
<p th:text="|작성 날짜: ${#dates.format(board.boardCreatedTime, 'yyyy-MM-dd')}|"></p>
<p th:text="${board.content}">내용이 들어갈 부분입니다</p>
<a th:href="@{${board.filepath}}">다운받기</a>
<a th:href="@{/board/delete(boardId=${board.id})}">글 삭제</a>
<a th:href="@{/board/modify/{boardId}(boardId=${board.id})}">글 수정</a>
<p></p>
<div>
    <input type="text" id="commentWriter" placeholder="작성자">
    <input type="text" id="commentContents" placeholder="내용">
    <button id="comment-write-btn" onclick="commentWrite()">댓글작성</button>
</div>
<p></p>
<div id="comment-list">
    <table>
        <thead>
        <tr>
            <th>댓글번호</th>
            <th>작성자</th>
            <th>내용</th>
            <th>작성시간</th>
        </tr>
        </thead>
        <tbody>
            <tr th:each="comment : ${commentList}">
                <td th:text="${comment.id}"></td>
                <td th:text="${comment.commentWriter}"></td>
                <td th:text="${comment.commentContents}"></td>
                <td th:text="${comment.commentCreatedTime}"></td>
            </tr>
        </tbody>
    </table>
</div>
</body>
<script th:inline="javascript">
    const commentWrite = () => {
        const writer = document.getElementById('commentWriter').value;
        const contents = document.getElementById('commentContents').value;
        const post = '[[${board.id}]]';

        $.ajax({
            type: "POST",
            url: "/comment/save",
            contentType: "application/json",
            data: JSON.stringify({
                commentWriter: writer,
                commentContents: contents,
                postId: post
            }),
            dataType: "json",
            success: function (commentList) {
                console.log("작성 성공");
                console.log(commentList);
                let output = "<table>";
                output += "<tr><th>댓글번호</th>";
                output += "<th>작성자</th>";
                output += "<th>내용</th>";
                output += "<th>작성시간</th></tr>";
                for(let i in commentList){
                    output += "<tr>";
                    output += "<td>"+commentList[i].id+"</td>";
                    output += "<td>"+commentList[i].commentWriter+"</td>";
                    output += "<td>"+commentList[i].commentContents+"</td>";
                    output += "<td>"+commentList[i].commentCreatedTime+"</td>";
                    output += "</tr>";
                }
                output += "</table>";
                document.getElementById('comment-list').innerHTML = output;
                document.getElementById('commentWriter').value='';
                document.getElementById('commentContents').value='';
            },
            error: function () {
                console.log("작성 실패");
            }
        });
    };
</script>

<script th:inline="javascript">
    $(document).ready(function () {
        const memberId = 1;  // 임시 회원 ID (실제 로그인 정보 연동 필요)
        const articleId = '[[${board.id}]]';

        // 좋아요 여부 확인 후 하트 색 변경
        $.get(`/like/${memberId}/${articleId}`, function (isLiked) {
            if (isLiked) {
                $("#heart-button").text("❤️");
            }
        });

        // 하트 클릭 이벤트
        $("#heart-button").click(function () {
            if ($("#heart-button").text() === "🤍") {
                $.ajax({
                    type: "POST",
                    url: `/like/${memberId}/${articleId}`,
                    success: function (response) {
                        console.log(response);
                        $("#heart-button").text("❤️");
                        let newCount = parseInt($("#heart-button").text()) + 1;
                        $("#heart-button").text(newCount);
                    },
                    error: function () {
                        console.log("좋아요 추가 실패");
                    }
                });
            } else {
                $.ajax({
                    type: "DELETE",
                    url: `/like/${memberId}/${articleId}`,
                    success: function (response) {
                        console.log(response);
                        $("#heart-button").text("🤍");
                        let newCount = Math.max(0, parseInt($("#heart-button").text()) - 1);
                        $("#heart-button").text(newCount);
                    },
                    error: function () {
                        console.log("좋아요 삭제 실패");
                    }
                });
            }
        });
    });

</script>

</html>
