<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ê²Œì‹œê¸€ ìƒì„¸ í˜ì´ì§€</title>
    <script src="https://code.jquery.com/jquery-3.6.3.min.js"></script>
</head>
<body>
<h1 th:text="${board.title}">ì œëª©ì…ë‹ˆë‹¤</h1>
<p>
    <span id="heart-button">ğŸ¤</span>
    <span id="heart-count" th:text="${board.heartCount}">0</span>
</p>

<p th:text="|ì¡°íšŒìˆ˜ : ${board.viewCount}|">ì¡°íšŒìˆ˜</p>
<p th:text="|ì‘ì„±ì: ${board.memberId}|">ì‘ì„±ì</p>
<p th:text="|ì‘ì„± ë‚ ì§œ: ${#dates.format(board.boardCreatedTime, 'yyyy-MM-dd')}|"></p>
<p th:text="${board.content}">ë‚´ìš©ì´ ë“¤ì–´ê°ˆ ë¶€ë¶„ì…ë‹ˆë‹¤</p>

<!-- ì´ë¯¸ì§€ íŒŒì¼ í‘œì‹œ -->
<div th:if="${board.filename}">
    <img th:src="${board.filepath}" alt="ê²Œì‹œê¸€ ì´ë¯¸ì§€" style="max-width: 100%; height: auto;">
</div>

<th:block th:if="${board.memberId == 'testUser'}">
    <a th:href="@{/free-board/delete/{boardId}/{memberId}(boardId=${board.id}, memberId=${board.memberId})}">ì‚­ì œ</a>
    <a th:href="@{/free-board/modify/{boardId}/{memberId}(boardId=${board.id}, memberId=${board.memberId})}">ìˆ˜ì •</a>
</th:block>

<div>
    <input type="text" id="commentContents" placeholder="ë‚´ìš©">
    <button id="comment-write-btn" onclick="commentWrite()">ëŒ“ê¸€ì‘ì„±</button>
</div>

<div id="comment-list">
    <table>
        <thead>
        <tr>
            <th>ëŒ“ê¸€ë²ˆí˜¸</th>
            <th>ì‘ì„±ì</th>
            <th>ë‚´ìš©</th>
            <th>ì‘ì„±ì‹œê°„</th>
            <th>ì‚­ì œ</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="comment : ${commentList}">
            <td th:text="${comment.id}"></td>
            <td th:text="${comment.memberId}"></td>
            <td th:text="${comment.commentContents}"></td>
            <td th:text="${#dates.format(comment.commentCreatedTime, 'yyyy-MM-dd HH:mm')}"></td>
            <td>
                <button th:attr="onclick='deleteComment(' + ${comment.id} + ',\'' + ${comment.memberId} + '\')'">ì‚­ì œ</button>
            </td>
        </tr>
        </tbody>
    </table>
</div>

<script th:inline="javascript">
    function commentWrite() {
        const memberId = "testUser";  // ë¡œê·¸ì¸ ì—°ë™ ì „ ì„ì‹œ ì‚¬ìš©ì
        const contents = document.getElementById('commentContents').value;
        const boardId = '[[${board.id}]]';

        $.ajax({
            type: "POST",
            url: "/free-comment/save",
            contentType: "application/json",
            data: JSON.stringify({
                memberId: memberId,
                commentContents: contents,
                boardId: boardId
            }),
            dataType: "json",
            success: function (commentList) {
                console.log("ì‘ì„± ì„±ê³µ", commentList);
                let output = "<table>";
                output += "<tr><th>ëŒ“ê¸€ë²ˆí˜¸</th><th>ì‘ì„±ì</th><th>ë‚´ìš©</th><th>ì‘ì„±ì‹œê°„</th><th>ì‚­ì œ</th></tr>";
                for (let i in commentList) {
                    output += "<tr>";
                    output += `<td>${commentList[i].id}</td>`;
                    output += `<td>${commentList[i].memberId}</td>`;
                    output += `<td>${commentList[i].commentContents}</td>`;
                    output += `<td>${commentList[i].commentCreatedTime}</td>`;
                    output += `<td><button onclick="deleteComment(${commentList[i].id}, '${commentList[i].memberId}')">ì‚­ì œ</button></td>`;
                    output += "</tr>";
                }
                output += "</table>";
                document.getElementById('comment-list').innerHTML = output;
                document.getElementById('commentContents').value = '';
            },
            error: function () {
                console.log("ëŒ“ê¸€ ì‘ì„± ì‹¤íŒ¨");
            }
        });
    }

    function deleteComment(commentId, memberId) {
        const currentUser = "testUser"; // ì„ì‹œ ì‚¬ìš©ì ID
        if (memberId !== currentUser) {
            alert("ë³¸ì¸ì´ ì‘ì„±í•œ ëŒ“ê¸€ë§Œ ì‚­ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
            return;
        }

        $.ajax({
            type: "DELETE",
            url: `/free-comment/delete/${commentId}/${memberId}`,
            success: function () {
                alert("ëŒ“ê¸€ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                location.reload();
            },
            error: function (xhr) {
                alert(xhr.responseText || "ì‚­ì œ ì‹¤íŒ¨");
            }
        });
    }

    $(document).ready(function () {
        const memberId = "testUser";  // ë¡œê·¸ì¸ ì—°ë™ ì „ ì„ì‹œ ì‚¬ìš©ì
        const boardId = '[[${board.id}]]';

        // ì¢‹ì•„ìš” ì—¬ë¶€ í™•ì¸
        $.get(`/free-board/like/${boardId}/${memberId}`, function (isLiked) {
            if (isLiked) {
                $("#heart-button").text("â¤ï¸");
            }
        });

        // ì¢‹ì•„ìš” ì¶”ê°€ ë° ì‚­ì œ
        $("#heart-button").click(function () {
            let heartCount = parseInt($("#heart-count").text()) || 0; // NaN ë°©ì§€

            if ($("#heart-button").text() === "ğŸ¤") {
                $.ajax({
                    type: "POST",
                    url: `/free-board/like/${boardId}/${memberId}`,
                    success: function () {
                        $("#heart-button").text("â¤ï¸");
                        $("#heart-count").text(heartCount + 1);
                    },
                    error: function () {
                        console.log("ì¢‹ì•„ìš” ì¶”ê°€ ì‹¤íŒ¨");
                    }
                });
            } else {
                $.ajax({
                    type: "DELETE",
                    url: `/free-board/like/${boardId}/${memberId}`,
                    success: function () {
                        $("#heart-button").text("ğŸ¤");
                        $("#heart-count").text(Math.max(0, heartCount - 1));
                    },
                    error: function () {
                        console.log("ì¢‹ì•„ìš” ì‚­ì œ ì‹¤íŒ¨");
                    }
                });
            }
        });
    });
</script>
</body>
</html>
